language: generic

os: osx

env:
  global:
    - REPO_DIR=orange3
    - BUILD_BRANCH=master
    - BUILD_COMMIT=3.19.0
    # Token generated using:
    #    anaconda auth --create --name CI-UPLOAD --scopes "repos pypi api:read api:write"
    #- ANACONDA_CLOUD_TOKEN=...
    - secure: "07zAlPFT27b6Ja54EYO6R1hzVH9GStRvXghEaPYobJXmda6qVkPkfsJOYXhQYaNmwY6IwEDvf00VaqxbWVxnfWkxzPhhIom8ePG2NXuhcbODpIPjA8KgWYJpgRQWcVTz8yoF1gldzpwZ/6+QzvVIpSPx0/04/AHRm4QS7O0t1luhGYUdMe9xJBRTN834L3KUAWbRPmtx1Z1+gsAFUSsv8I1H4tHKhOyCuZ8GMQsSLi4K62mTAvu0dmVEFOsmqj+O+ZdD3k+yeknmuPefD25biKJcJBCprq75EtGR7OLYoC/oCF3h4UuofkW999w5oyvM9qFEouxEM4X2geqQk/96C65imh2hGnEHyJQNo936lAh9Wd1yjxAd36PPCuiiB2qTvoSaNVoSBxgxvDD3t2GllZsp2/F8ve3jSrnN2lIn4AMyqMmIjufejbE8ITBErnCnbnxXDjsIcYZq1kYhz2iF7kGndUI0C3qiWH+DNQXAKuVvynrGpx64xA5PVfqhvpkvWfgv53vQ/F1RC/49Ez10ntAAFDMlsPp0oAkejz7YTJG5fmDFM5yb6BgyHE7Bh6sxgLd5xty2dWZhW1XJCd7kHLWSzlgjOV+Vsf19t+OYbQtkpQGLm0YE5b37u8JTCcMuoPQUGkpxkyl/AROqx/VE+YCX35zoqr3hyAnH/dFaHoM="

    - STAGING_INDEX=https://pypi.anaconda.org/ales-erjavec/simple/
    - PIP_DISABLE_PIP_VERSION_CHECK=1
    # PyPi wheel build requirements
    - WHEEL_VER=0.29
    - PIP_VER=9.0.3
    - NUMPY_BUILD_VER=1.9.3
    - SPHINX_BUILD_VER=1.8.2

  matrix:
    - PYVER=3.6.0 NUMPY_VER=1.11.3 SCIPY_VER=0.18.1 SCIKIT_LEARN_VER==0.18.1
    - PYVER=3.7.0 NUMPY_BUILD_VER=1.14.5 NUMPY_VER=1.14.5 SCIPY_VER=1.1.0 SCIKIT_LEARN_VER=0.19.2

cache:
#  pip: true
  ccache: true
  directories:
    - ~/Library/Caches/pip
    - ~/Library/Caches/vagabond

before_install:
  # Use 3.6 from python.org to download/upload reqs (need newer openssl then
  # the system provided used in older python releases )
  - ./tools/osx/install-python 3.6.0
  - ./tools/osx/init-venv --python 3.6 ~/.venv/util
  - PYTAG=${PYVER%.*}; PYTAG=${PYTAG/./}
  - DOWNLOAD_ARGS="--python-version $PYTAG --abi cp${PYTAG}m --only-binary :all:"
  - ~/.venv/util/bin/pip install -U pip==9.0.1
  - ~/.venv/util/bin/pip download $DOWNLOAD_ARGS -d ./wheels --extra-index-url $STAGING_INDEX numpy==$NUMPY_BUILD_VER pip==$PIP_VER wheel==$WHEEL_VER
  - ~/.venv/util/bin/pip download $DOWNLOAD_ARGS -d ./wheels --extra-index-url $STAGING_INDEX numpy==$NUMPY_VER scipy==$SCIPY_VER scikit-learn==$SCIKIT_LEARN_VER

  # set up the build/test env
  - test ! "$PYVER" == 3.6.1  # https://bugs.python.org/issue29943
  - ./tools/osx/install-python $PYVER
  - ./tools/osx/init-venv --python ${PYVER%.*} ~/.venv/${PYVER%.*}
  - source ~/.venv/${PYVER%.*}/bin/activate
  - pip install -f ./wheels wheel==$WHEEL_VER pip==$PIP_VER sphinx==$SPHINX_BUILD_VER
  - pip install -f ./wheels --only-binary numpy numpy==$NUMPY_BUILD_VER

install:
  - cd $REPO_DIR
  - git fetch origin $BUILD_BRANCH
  - git checkout $BUILD_COMMIT
  - echo $(python --version) $(which python)
  - python setup.py config --with-htmlhelp bdist_wheel --dist-dir ../dist
  - cd ..

script:
  - pip install -f ./wheels numpy==$NUMPY_VER scipy==$SCIPY_VER scikit-learn==$SCIKIT_LEARN_VER
  - pip install --no-index --find-links ./dist --no-deps --pre Orange3
  - pip install --find-links ./wheels Orange3
  # Cannot run full core test suite yet
  - python -c "import Orange.data, Orange.classification, Orange.regression, Orange.clustering"

after_success:
  - md5 dist/*.whl
  - curl --upload-file dist/*.whl https://transfer.sh/
  - ~/.venv/util/bin/pip install -q anaconda-client
  - ~/.venv/util/bin/anaconda --token $ANACONDA_CLOUD_TOKEN upload --no-progress --label staging --force dist/*.whl
